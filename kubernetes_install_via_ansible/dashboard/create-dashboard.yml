- hosts: master
  vars:
    service_user: ansible_serviece_user
    configuration_file_location: /home/{{ service_user }}/kube_install_data/dashboard
  remote_user: "{{ service_user }}"
  become: yes
  tasks:
    - name: install kubernetes dashboard
      become_user: "{{ service_user }}"
      shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml
      register: dashboard_output

    - debug:
        msg: dashboard_output.stdout_lines

    - name: Copy multiple files in Ansible with different permissions
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      with_items:
        - {
            src: "cluster-role.yaml",
            dest: "{{ configuration_file_location }}/cluster-role.yaml",
          }
        - {
            src: "dashboard-adminuser.yaml",
            dest: "{{ configuration_file_location }}/dashboard-adminuser.yaml",
          }

    - name: create dashboard admin user
      shell: kubectl apply -f {{ configuration_file_location }}/dashboard-adminuser.yaml
      register: admin_user_output

    - debug:
        msg: "Andmin user create status {{admin_user_output.stdout_lines}}"

    - name: create cluster role
      shell: kubectl apply -f {{ configuration_file_location }}/cluster-role-rbac.yml
      register: clustercreate_output

    - debug:
        msg: "Dashboard create status {{ clustercreate_output.stdout_lines}}"

    - name: get user secret
      shell: kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '{print $1}')
      register: secret_token_output

    - debug:
        msg: "Secrect token for kubernetes dashboard {{ secret_token_output.stdout_lines}}"
